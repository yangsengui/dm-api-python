name: Publish

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Package version (example: 0.1.0-beta.1)"
        required: false
        default: "0.1.0-beta.1"

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve package version
        id: meta
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="${{ inputs.version }}"
          fi

          if [[ -z "${version}" ]]; then
            echo "Version input is required." >&2
            exit 1
          fi

          echo "package_version=${version}" >> "${GITHUB_OUTPUT}"
          echo "tag_name=v${version}" >> "${GITHUB_OUTPUT}"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Convert version for PyPI
        id: pypi_version
        shell: bash
        env:
          PACKAGE_VERSION: ${{ steps.meta.outputs.package_version }}
        run: |
          pypi_version="$(python - <<'PY'
          import os
          import re

          version = os.environ["PACKAGE_VERSION"].strip()
          match = re.fullmatch(r"(\d+\.\d+\.\d+)(?:-([0-9A-Za-z.-]+))?", version)
          if not match:
              raise SystemExit(f"Unsupported version format: {version}")

          base, pre = match.groups()
          if not pre:
              print(base)
              raise SystemExit(0)

          pre = pre.lower().replace("-", ".")
          pre_match = re.fullmatch(r"(alpha|a|beta|b|rc)(?:\.?([0-9]+))?", pre)
          if not pre_match:
              raise SystemExit(f"Unsupported pre-release label for PyPI: {pre}")

          label, number = pre_match.groups()
          number = number or "0"

          if label in ("alpha", "a"):
              print(f"{base}a{number}")
          elif label in ("beta", "b"):
              print(f"{base}b{number}")
          else:
              print(f"{base}rc{number}")
          PY
          )"
          echo "value=${pypi_version}" >> "${GITHUB_OUTPUT}"
      - name: Set package version in pyproject.toml
        shell: bash
        env:
          PYPI_VERSION: ${{ steps.pypi_version.outputs.value }}
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          path = Path("pyproject.toml")
          content = path.read_text(encoding="utf-8")
          updated, count = re.subn(
              r'(?m)^version\s*=\s*".*"$',
              f'version = "{os.environ["PYPI_VERSION"]}"',
              content,
              count=1,
          )
          if count != 1:
              raise SystemExit("Failed to update version in pyproject.toml")
          path.write_text(updated, encoding="utf-8")
          PY
      - name: Build package
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          rm -rf dist
          python -m build
          twine check dist/*
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist-${{ steps.pypi_version.outputs.value }}
          path: dist/*
      - name: Publish package to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          prerelease: ${{ contains(steps.meta.outputs.package_version, '-') }}
          generate_release_notes: true
          files: dist/*
      - name: Publish to PyPI
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && env.PYPI_API_TOKEN != ''
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          password: ${{ env.PYPI_API_TOKEN }}
          skip-existing: true
